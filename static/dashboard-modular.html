<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Crazy Data Corp - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/styles.css?v=20251001-fix7" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js"></script>


  </head>
  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="brand"><img class="brand-logo" src="/static/hippo.png" alt="Logo" /> Crazy Data Corp</div>
        <div class="nav-actions">
          <button class="link" id="logout">Logout</button>
        </div>
      </div>
    </div>
    <div class="container">
      <header class="header" style="margin-top:8px"><h1>Dashboard</h1></header>
      
      <!-- Metadata Section -->
      <div class="metadata-bar">
        <div class="metadata-item">
          <span class="metadata-label">Logged in as user =</span>
          <span class="metadata-value">Henrik Warfvinge</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Last analysis:</span>
          <span class="metadata-value" id="last-analysis">No analysis yet</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Data freshness:</span>
          <span class="metadata-value" id="data-freshness">Loading...</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Total records:</span>
          <span class="metadata-value" id="total-records">Loading...</span>
        </div>
      </div>
      
      <!-- Priorities Section -->
      <section class="panel" id="priorities-panel">
        <div class="panel-header">
          <div class="accordion-header-content">
            <button class="accordion-toggle" id="priorities-toggle" aria-expanded="false" aria-controls="priorities-content">
              <span class="accordion-icon">‚ñ∂</span>
              <div class="accordion-title-row">
                <h2>Your proposed priorities</h2>
                <span class="status-dot empty" id="priorities-status-dot"></span>
              </div>
            </button>
            <div class="accordion-metadata" id="priorities-metadata">
              <span class="meta-badge primary">
                <span class="icon">üìä</span>
                <span id="priority-count">0 priorities</span>
              </span>
              <div class="category-tags" id="priority-categories"></div>
              <span class="time-badge">
                <span class="icon">üïê</span>
                <span id="last-analyzed-mini">No analysis yet</span>
              </span>
            </div>
          </div>
        </div>
        <div class="panel-content accordion-content" id="priorities-content" style="display: none;">
          <!-- Analysis Actions -->
          <div class="panel-actions" style="margin-bottom: 16px;">
            <button class="btn btn-primary" id="analyze">Analyze</button>
            <button class="btn btn-secondary" id="clear-priorities">Clear</button>
          </div>
          
          <div class="analysis-summary" id="analysis-summary"></div>
          <div class="priorities-grid">
            <div class="priority-group">
              <h3>Short-term (Last 2 weeks)</h3>
              <div class="priority-cards" id="short-term-priorities"></div>
            </div>
            <div class="priority-group">
              <h3>Long-term (Last 90 days)</h3>
              <div class="priority-cards" id="long-term-priorities"></div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- KPI Section -->
      <section class="panel" id="kpi-panel">
        <div class="panel-header">
          <h2>Key Performance Indicators</h2>
        </div>
        <div class="panel-content">
          <div class="kpi-grid" id="kpi-grid"></div>
        </div>
      </section>
      
      <!-- Metrics Section -->
      <section class="panel" id="metrics-panel">
        <div class="panel-header">
          <h2>Metrics & Visualizations</h2>
          <div class="panel-actions">
            <button class="btn btn-primary" id="btn-add-custom-viz">Add Custom Visualization</button>
          </div>
        </div>
        <div class="panel-content">
          <div id="metrics-container"></div>
          <div id="topic-groups"></div>
        </div>
      </section>
      
      <!-- Schema Section (for custom roles) -->
      <section class="panel" id="schema-panel" style="display: none;">
        <div class="panel-header">
          <h2>Database Schema</h2>
        </div>
        <div class="panel-content">
          <div id="schema-info"></div>
        </div>
      </section>
    </div>
    
    <!-- Custom Visualization Modal -->
    <div id="custom-viz-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create Custom Visualization</h3>
          <button id="custom-viz-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="custom-viz-title">Chart Title:</label>
            <input type="text" id="custom-viz-title" placeholder="Enter chart title" />
          </div>
          <div class="form-group">
            <label for="custom-viz-description">Description:</label>
            <textarea id="custom-viz-description" placeholder="Describe what you want to visualize..." rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="custom-viz-cancel" class="btn btn-secondary">Cancel</button>
          <button id="custom-viz-generate" class="btn btn-primary">Generate Chart</button>
        </div>
      </div>
    </div>
    
    <!-- Load modular JavaScript files -->
    <script src="/static/js/utils/formatters.js?v=2"></script>
    <script src="/static/js/utils/ui.js?v=2"></script>
    <script src="/static/js/components/kpi.js?v=2"></script>
    <script src="/static/js/components/metrics.js?v=2"></script>
    <script src="/static/js/components/accordion-metadata.js?v=2"></script>
    <script src="/static/js/components/modals.js?v=2"></script>
    <script src="/static/js/components/query-generator.js?v=2"></script>
    <script src="/static/js/components/communication-generator.js?v=2" 
            onload="console.log('‚úÖ communication-generator.js loaded successfully')"
            onerror="console.error('‚ùå Failed to load communication-generator.js')"></script>
    <script>
        // CACHE BUSTER - Debug script loading v2
        console.log('üîÑ CACHE BUSTER v2 - Checking if CommunicationGenerator is loaded:', typeof CommunicationGenerator !== 'undefined');
        console.log('üîÑ Available functions:', typeof initializeModalListeners !== 'undefined' ? 'initializeModalListeners OK' : 'initializeModalListeners MISSING');
        
        if (typeof CommunicationGenerator === 'undefined') {
            console.error('‚ùå CommunicationGenerator failed to load from /static/js/components/communication-generator.js');
            console.log('Available globals:', Object.keys(window).filter(k => k.includes('Generator')));
            
            // TEMPORARY FIX: Define CommunicationGenerator inline
            console.log('üîß Creating temporary inline CommunicationGenerator...');
            window.CommunicationGenerator = class CommunicationGenerator {
                constructor(container, actionId, step) {
                    console.log('üîß CommunicationGenerator instantiated with:', { actionId, taskId: step.id });
                    container.innerHTML = '<p style="color: blue; font-weight: bold;">üìû Communication Generator loaded inline (temporary fix) v2</p>';
                }
            };
            console.log('‚úÖ Temporary CommunicationGenerator created v2');
        } else {
            console.log('‚úÖ CommunicationGenerator class is available from external file');
        }
    </script>
    <script src="/static/js/components/action-plan.js?v=2"></script>
    <script src="/static/js/services/visualizer.js"></script>
    <script src="/static/js/dashboard-app.js"></script>
    
    <!-- Legacy functions for compatibility -->
    <script>
      // Table sorting function (legacy)
      function sortTable(header) {
        const table = header.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const columnIndex = Array.from(header.parentNode.children).indexOf(header);
        
        const isAscending = header.classList.contains('sort-asc');
        
        // Clear all sort classes
        header.parentNode.querySelectorAll('th').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Sort rows
        rows.sort((a, b) => {
          const aVal = a.children[columnIndex].textContent.trim();
          const bVal = b.children[columnIndex].textContent.trim();
          
          // Try to parse as numbers
          const aNum = parseFloat(aVal);
          const bNum = parseFloat(bVal);
          
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? bNum - aNum : aNum - bNum;
          } else {
            return isAscending ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
          }
        });
        
        // Update sort class
        header.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
        
        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
      }
      
      // Insights display function (legacy)
      function displayInsights(container, insights) {
        if (!container || !insights) return;
        
        container.innerHTML = `
          <div class="insights-content">
            <h4>Key Insights</h4>
            <ul>
              ${insights.map(insight => `<li>${escapeHtml(insight)}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      // Auto-load insights function (legacy)
      function autoLoadInsightsForChart(chartTitle, chartData, chartType, chartId) {
        // This function is now handled by the modal system
        console.log('Auto-load insights called for:', chartTitle);
      }
    </script>
  </body>
</html>
