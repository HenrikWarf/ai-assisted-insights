<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Crazy Fashion Corp - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/styles.css?v=20251001-fix7" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  </head>
  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="brand"><img class="brand-logo" src="/static/hippo.png" alt="Logo" /> Crazy Fashion Corp</div>
        <div class="nav-actions">
          <button class="link" id="logout">Logout</button>
        </div>
      </div>
    </div>
    <div class="container">
      <header class="header" style="margin-top:8px"><h1>Dashboard</h1></header>
      
      <!-- Metadata Section -->
      <div class="metadata-bar">
        <div class="metadata-item">
          <span class="metadata-label">Logged in as:</span>
          <span class="metadata-value" id="logged-in-user">Loading...</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Last analysis:</span>
          <span class="metadata-value" id="last-analysis">No analysis yet</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Data freshness:</span>
          <span class="metadata-value" id="data-freshness">Loading...</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Total records:</span>
          <span class="metadata-value" id="total-records">Loading...</span>
        </div>
      </div>
      
      <!-- Priorities Section -->
      <section class="panel" id="priorities-panel">
        <div class="panel-header">
          <div class="accordion-header-content">
            <button class="accordion-toggle" id="priorities-toggle" aria-expanded="false" aria-controls="priorities-content">
              <span class="accordion-icon">â–¶</span>
              <div class="accordion-title-row">
                <h2>Your proposed priorities</h2>
                <span class="status-dot empty" id="priorities-status-dot"></span>
              </div>
            </button>
            <div class="accordion-metadata" id="priorities-metadata">
              <span class="meta-badge primary">
                <span class="icon">ğŸ“Š</span>
                <span id="priority-count">0 priorities</span>
              </span>
              <div class="category-tags" id="priority-categories"></div>
              <span class="time-badge">
                <span class="icon">ğŸ•</span>
                <span id="last-analyzed-mini">No analysis yet</span>
              </span>
            </div>
          </div>
        </div>
        
        <div class="accordion-content" id="priorities-content" style="display: none;">
        
        <!-- Analysis Actions -->
        <div class="actions" style="margin-bottom: 16px; display: flex; gap: 8px;">
          <button class="primary" id="analyze">Analyze with Gemini</button>
          <button class="secondary" id="clear-priorities">Clear Results</button>
        </div>
        
        <!-- Short Term Priorities -->
        <div class="priority-section">
          <div class="section-header">
            <h3>ğŸš€ Short Term Priorities</h3>
            <span class="section-subtitle">Last 2 weeks - Immediate actions</span>
          </div>
          <div id="short-term-summary" class="summary-card" aria-live="polite" style="display:none">
            <div class="title">Short Term Summary</div>
            <div class="body" id="short-term-summary-body"></div>
          </div>
          <div class="priority-grid" id="short-term-grid">
            <div class="priority-card" data-slot="1"></div>
            <div class="priority-card" data-slot="2"></div>
            <div class="priority-card" data-slot="3"></div>
          </div>
        </div>

        <!-- Long Term Priorities -->
        <div class="priority-section">
          <div class="section-header">
            <h3>ğŸ¯ Long Term Priorities</h3>
            <span class="section-subtitle">Last 90 days - Strategic direction</span>
          </div>
          <div id="long-term-summary" class="summary-card" aria-live="polite" style="display:none">
            <div class="title">Long Term Summary</div>
            <div class="body" id="long-term-summary-body"></div>
          </div>
          <div class="priority-grid" id="long-term-grid">
            <div class="priority-card" data-slot="1"></div>
            <div class="priority-card" data-slot="2"></div>
            <div class="priority-card" data-slot="3"></div>
          </div>
        </div>
        </div>
      </section>
      
      <!-- Saved Analyses Section -->
      <section class="panel" id="saved-analyses-panel">
        <div class="panel-header">
          <div class="accordion-header-content">
            <button class="accordion-toggle" id="saved-analyses-toggle" aria-expanded="false" aria-controls="saved-analyses-content">
              <span class="accordion-icon">â–¶</span>
              <div class="accordion-title-row">
                <h2>ğŸ“š Workspace</h2>
              </div>
            </button>
            <div class="accordion-metadata" id="workspace-metadata">
              <span class="meta-badge primary">
                <span class="icon">ğŸ“</span>
                <span id="workspace-count">0 saved</span>
              </span>
              <span class="meta-badge success">
                <span class="icon">ğŸ’¡</span>
                <span id="insights-count">0 with insights</span>
              </span>
              <span class="meta-badge info">
                <span class="icon">ğŸ“</span>
                <span id="workspace-notes-total">0 notes</span>
              </span>
              <span class="time-badge">
                <span class="icon">ğŸ•</span>
                <span id="workspace-last-activity">Never updated</span>
              </span>
            </div>
          </div>
        </div>
        <div class="panel-content" id="saved-analyses-content" style="display: none;">
          <div class="saved-analyses-container">
            <div class="saved-analyses-header">
              <p>Your saved priority workspaces for future reference and further analysis.</p>
            </div>
            <div id="saved-analyses-list" class="saved-analyses-list">
              <div class="empty-state">
                <p>No saved workspaces yet. Use the "ğŸ’¾ Save Analysis" button in the Explore & Act modal to save your priority workspaces.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Saved Actions Section -->
      <section class="panel" id="saved-actions-panel">
        <div class="panel-header">
          <div class="accordion-header-content">
            <button class="accordion-toggle" id="saved-actions-toggle" aria-expanded="false" aria-controls="saved-actions-content">
              <span class="accordion-icon">â–¶</span>
              <div class="accordion-title-row">
                <h2>ğŸ¯ Saved Actions</h2>
              </div>
            </button>
            <div class="accordion-metadata" id="actions-metadata">
              <span class="meta-badge primary">
                <span class="icon">ğŸ“Š</span>
                <span id="total-actions-count">0 actions</span>
              </span>
              <span class="meta-badge warning" id="urgent-actions-badge" style="display: none;">
                <span class="icon">âš¡</span>
                <span id="urgent-actions">0 urgent</span>
              </span>
              <span class="meta-badge info" id="status-breakdown-text">
                <span id="status-text-content">0 pending Â· 0 in-progress Â· 0 done</span>
              </span>
              <span class="time-badge">
                <span class="icon">ğŸ•</span>
                <span id="actions-last-update">Never updated</span>
              </span>
            </div>
          </div>
        </div>
        <div class="panel-content" id="saved-actions-content" style="display: none;">
          <div class="saved-actions-container">
            <div class="saved-actions-header">
              <p>Your saved actions from the Explore Action feature. These are detailed action plans you can reference and continue working on.</p>
            </div>
            <div id="saved-actions-list" class="saved-actions-list">
              <div class="empty-state">
                <p>No saved actions yet. Use the "ğŸ” Explore Action" button in priority insights, then "ğŸ’¾ Save to Workspace" to save your action plans.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- legacy analysis panel removed; progress now shown inline above cards -->
      <section class="panel">
        <h2>Key Performance Indicators</h2>
        <div id="kpi-grid" class="kpi-grid"></div>
      </section>
        <section class="panel" id="content-section-panel">
          <h2>Content</h2>
          <div id="section-links" class="section-links" aria-label="Quick links to sections"></div>
        </section>
        <section class="panel" id="schema-section-panel">
          <h2>Available Data Fields</h2>
          <div id="schema-info" class="schema-info">
            <div class="schema-loading">Loading available data fields...</div>
          </div>
        </section>
      <section class="panel" id="custom-viz-section-panel">
        <h2>Custom Visualizations</h2>
        <div style="margin-top: 16px;">
          <button class="primary" id="btn-add-custom-viz" style="color: white !important;"><span style="color: white;">+</span> Add Custom Visualization</button>
        </div>
      </section>
      <section class="panel">
        <div id="topic-groups" class="topics"></div>
      </section>
    </div>

    <!-- Modal markup is loaded dynamically from modal.html -->
    <div id="modal-mount"></div>
    
    <!-- Custom Visualization Modal -->
    <div id="custom-viz-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="custom-viz-title">Add Custom Visualization</h3>
          <button class="modal-close" id="custom-viz-close">&times;</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 16px;">
            <label for="custom-viz-input" style="display: block; margin-bottom: 8px; font-weight: 600;">Describe what you want to visualize:</label>
                <textarea 
                  id="custom-viz-input" 
                  placeholder="Describe what you want to visualize. Examples:
â€¢ 'Show me customer acquisition trends by month' (line chart)
â€¢ 'Compare sales by product category' (bar chart)  
â€¢ 'Breakdown of customers by age group' (pie chart)
â€¢ 'List all high-value customers with details' (table)
â€¢ 'Create a pie chart showing revenue by region'
â€¢ 'Make a line chart of monthly growth'"
                  style="width: 100%; height: 100px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"
                ></textarea>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #374151;">
              <input type="checkbox" id="enhanced-insights-checkbox" checked style="width: 16px; height: 16px;">
              <span>ğŸ” Generate Enhanced Insights</span>
            </label>
            <div style="font-size: 12px; color: #6b7280; margin-top: 4px; margin-left: 24px;">
              Automatically generate AI-powered insights and recommendations based on your chart data
            </div>
          </div>
          <div id="custom-viz-status" style="margin-bottom: 16px; font-size: 14px; color: #666;"></div>
        </div>
        <div class="modal-footer" style="margin-top: 20px; padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-start;">
          <button class="primary" id="custom-viz-generate">Generate Visualization</button>
          <button class="secondary" id="custom-viz-cancel">Cancel</button>
        </div>
      </div>
    </div>
    
    <script src="/static/modal.js"></script>
    <script src="/static/js/components/modals.js"></script>
    <script src="/static/js/components/kpi.js"></script>
    <script src="/static/js/components/metrics.js"></script>
    <script src="/static/js/components/accordion-metadata.js"></script>
    <script src="/static/js/components/priority-explore-modal.js"></script>
    <script src="/static/js/components/explore-action-modal.js"></script>
    <script src="/static/js/components/query-generator.js"></script>
    <script src="/static/js/components/communication-generator.js?v=4" 
            onload="console.log('âœ… communication-generator.js loaded successfully')"
            onerror="console.error('âŒ Failed to load communication-generator.js')"></script>
    <script src="/static/js/components/ai-assistant.js?v=4" 
            onload="console.log('âœ… ai-assistant.js loaded successfully')"
            onerror="console.error('âŒ Failed to load ai-assistant.js')"></script>
    <script>
        // CACHE BUSTER - Debug script loading v5 (CORRECT FILE)
        console.log('ğŸ”„ CORRECT FILE v5 - Checking if CommunicationGenerator is loaded:', typeof CommunicationGenerator !== 'undefined');
        console.log('ğŸ”„ Checking if AIAssistant is loaded:', typeof AIAssistant !== 'undefined');
        console.log('ğŸ”„ Available functions:', typeof initializeModalListeners !== 'undefined' ? 'initializeModalListeners OK' : 'initializeModalListeners MISSING');
        
        if (typeof CommunicationGenerator === 'undefined') {
            console.error('âŒ CommunicationGenerator failed to load from /static/js/components/communication-generator.js');
            console.log('Available globals:', Object.keys(window).filter(k => k.includes('Generator')));
            
            // TEMPORARY FIX: Define CommunicationGenerator inline
            console.log('ğŸ”§ Creating temporary inline CommunicationGenerator...');
            window.CommunicationGenerator = class CommunicationGenerator {
                constructor(container, actionId, step) {
                    console.log('ğŸ”§ CommunicationGenerator instantiated with:', { actionId, taskId: step.id });
                    container.innerHTML = '<p style="color: blue; font-weight: bold;">ğŸ“ Communication Generator loaded inline (CORRECT FILE v3)</p>';
                }
            };
            console.log('âœ… Temporary CommunicationGenerator created v3');
        } else {
            console.log('âœ… CommunicationGenerator class is available from external file');
        }
    </script>
    <script src="/static/js/components/action-plan.js"></script>
    <script src="/static/js/services/visualizer.js"></script>
    <script src="/static/js/utils/ui.js"></script>
    <script src="/static/js/utils/formatters.js"></script>
    <script src="/static/js/dashboard-app.js"></script>
    <script>
      // If path is /dashboard/<role_name>, mark session role as custom in client for UI hints
      (function(){
        const parts = window.location.pathname.split('/');
        if (parts.length >= 3 && parts[1] === 'dashboard' && parts[2]) {
          window.__CUSTOM_ROLE_NAME__ = decodeURIComponent(parts.slice(2).join('/'));
        }
      })();
    </script>
    <script src="/static/dashboard.js"></script>
  </body>
  </html>


