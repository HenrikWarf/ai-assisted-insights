{
  "kpis": [
    {
      "id": "total-revenue",
      "title": "Total Revenue",
      "description": "The total revenue generated from all purchases. It's calculated by summing the 'total_amount' for all 'purchase' events.",
      "formula": "SELECT COALESCE(SUM(\"total_amount\"), 0) FROM \"web_events\" WHERE \"event_type\" = 'purchase_completed'",
      "table": "web_events"
    },
    {
      "id": "total-orders",
      "title": "Total Orders",
      "description": "The total number of unique orders placed.",
      "formula": "SELECT COUNT(DISTINCT \"order_id\") FROM \"web_events\" WHERE \"order_id\" IS NOT NULL",
      "table": "web_events"
    },
    {
      "id": "total-unique-visitors",
      "title": "Total Unique Visitors",
      "description": "The total number of distinct customers who visited the website.",
      "formula": "SELECT COUNT(DISTINCT \"customer_id\") FROM \"web_events\"",
      "table": "web_events"
    },
    {
      "id": "total-sessions",
      "title": "Total Sessions",
      "description": "The total number of unique sessions on the website.",
      "formula": "SELECT COUNT(DISTINCT \"session_id\") FROM \"web_events\"",
      "table": "web_events"
    },
    {
      "id": "average-cart-value",
      "title": "Average Value of Item Added to Cart",
      "description": "This KPI was improved to correctly calculate the value of an item at the moment it is added to the cart. The original formula used the `cart_value` column, which is likely not populated for 'add_to_cart' events, resulting in a value of 0. The new formula calculates the value by multiplying `product_price` by `quantity` for each 'add_to_cart' event, providing a more accurate and meaningful metric.",
      "formula": "SELECT COALESCE(AVG(\"product_price\" * \"quantity\"), 0) FROM \"web_events\" WHERE \"event_type\" = 'add_to_cart'",
      "table": "web_events"
    },
    {
      "id": "coupon-usage-rate",
      "title": "Coupon Usage Rate",
      "description": "The original query returned 0 because of integer division. The `AVG` function operating on an `INTEGER` column was likely truncating the decimal part of the result (e.g., 45 / 100 = 0). This improved formula fixes the calculation by casting the \"coupon_used\" column to a `REAL` (floating-point) type before calculating the average. This forces floating-point arithmetic, ensuring an accurate percentage of completed orders that used a coupon.",
      "formula": "SELECT COALESCE(AVG(CAST(\"coupon_used\" AS REAL)) * 100, 0) FROM \"web_events\" WHERE \"event_type\" = 'purchase'",
      "table": "web_events"
    },
    {
      "id": "average-items-per-order",
      "title": "Average Items Per Order",
      "description": "This KPI is now calculated by summing the 'quantity' of all purchased items and dividing by the count of distinct 'order_id's. This provides a more accurate and robust calculation than relying on the pre-aggregated 'item_count' field, which may have been incorrect or incomplete, leading to a result of 0. This revised formula computes the average from raw event data, ensuring a true representation of items per completed order.",
      "formula": "SELECT COALESCE(CAST(SUM(\"item_count\") AS REAL) / COUNT(DISTINCT \"order_id\"), 0.0) \nFROM \"web_events\" \nWHERE \"event_type\" = 'purchase_completed' AND \"order_id\" IS NOT NULL AND \"item_count\" IS NOT NULL",
      "table": "web_events"
    },
    {
      "id": "zero-result-search-rate",
      "title": "Zero Result Search Rate",
      "description": "The percentage of on-site searches that returned zero results.",
      "formula": "SELECT COALESCE(AVG(CASE WHEN \"results_count\" = 0 THEN 1.0 ELSE 0.0 END) * 100, 0) FROM \"web_events\" WHERE \"event_type\" = 'search'",
      "table": "web_events"
    },
    {
      "id": "purchase-frequency",
      "title": "Purchase Frequency",
      "description": "The average number of orders per customer.",
      "formula": "SELECT CAST(COUNT(DISTINCT \"order_id\") AS REAL) / COUNT(DISTINCT \"customer_id\") FROM \"web_events\" WHERE \"order_id\" IS NOT NULL",
      "table": "web_events"
    },
    {
      "id": "revenue-per-visitor",
      "title": "Revenue Per Visitor (RPV)",
      "description": "The average revenue generated per unique visitor, including those who did not make a purchase.",
      "formula": "SELECT COALESCE(SUM(\"total_amount\") * 1.0 / COUNT(DISTINCT \"customer_id\"), 0) FROM \"web_events\"",
      "table": "web_events"
    },
    {
      "id": "events-per-session",
      "title": "Events Per Session",
      "description": "The average number of events (e.g., page views, clicks) that occur in a single session.",
      "formula": "SELECT CAST(COUNT(\"event_id\") AS REAL) / COUNT(DISTINCT \"session_id\") FROM \"web_events\"",
      "table": "web_events"
    }
  ],
  "charts": [
    {
      "id": "1",
      "title": "Event Type Distribution",
      "description": "The number of occurrences for each event type, showing the most common user actions on the website.",
      "type": "bar",
      "query_sql": "SELECT \"event_type\", COUNT(\"event_id\") AS \"count\" FROM \"web_events\" GROUP BY \"event_type\" ORDER BY \"count\" DESC;"
    },
    {
      "id": "3",
      "title": "Device Type Usage",
      "description": "A breakdown of user sessions by device type (e.g., desktop, mobile, tablet).",
      "type": "pie",
      "query_sql": "SELECT \"device_type\", COUNT(DISTINCT \"session_id\") AS \"session_count\" FROM \"web_events\" GROUP BY \"device_type\";"
    },
    {
      "id": "5",
      "title": "User Conversion Funnel",
      "description": "Shows the number of unique sessions that progressed through key stages: viewing a page, adding to cart, and making a purchase.",
      "type": "table",
      "query_sql": "SELECT 'Page Views' AS \"funnel_step\", COUNT(DISTINCT \"session_id\") AS \"unique_sessions\" FROM \"web_events\" WHERE \"event_type\" = 'page_view' UNION ALL SELECT 'Add to Cart' AS \"funnel_step\", COUNT(DISTINCT \"session_id\") AS \"unique_sessions\" FROM \"web_events\" WHERE \"event_type\" = 'add_to_cart' UNION ALL SELECT 'Purchases' AS \"funnel_step\", COUNT(DISTINCT \"session_id\") AS \"unique_sessions\" FROM \"web_events\" WHERE \"event_type\" = 'purchase';"
    },
    {
      "id": "9",
      "title": "Top 10 Unsuccessful Search Terms",
      "description": "Identifies the most frequent search terms that yielded zero results, highlighting potential gaps in product catalog or search issues.",
      "type": "bar",
      "query_sql": "SELECT \"search_term\", COUNT(\"event_id\") AS \"search_count\" FROM \"web_events\" WHERE \"event_type\" = 'search' AND \"results_count\" = 0 AND \"search_term\" IS NOT NULL GROUP BY \"search_term\" ORDER BY \"search_count\" DESC LIMIT 10;"
    }
  ],
  "insights": [
    "User Journey",
    "Web Traffic Patterns",
    "User Engagement",
    "Conversion Funnels",
    "Sessionization",
    "Marketing Channel Attribution"
  ]
}